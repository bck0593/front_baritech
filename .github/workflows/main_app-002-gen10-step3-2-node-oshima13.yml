name: Build and deploy Node.js app to Azure Web App - app-002-gen10-step3-2-node-oshima13

on:
  push:
    branches: [main]
  workflow_dispatch:

env:
  NODE_ENV: production
  NPM_CONFIG_LOGLEVEL: info

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js 20
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    - name: Verify npm configuration
      run: |
        echo "npm version: $(npm --version)"
        echo "node version: $(node --version)"
        cat .npmrc || echo "No .npmrc file found"

    - name: Clear npm cache
      run: npm cache clean --force

    - name: Install dependencies
      run: |
        npm ci --no-audit --no-fund
        npm list --depth=0

    - name: Verify project structure
      run: |
        echo "=== Project Structure ==="
        ls -la
        echo "=== Components directory ==="
        ls -la components/ || echo "No components directory"
        ls -la components/ui/ || echo "No components/ui directory"
        echo "=== tsconfig.json ==="
        cat tsconfig.json

    - name: Create symbolic link for components
      run: |
        echo "Creating absolute path resolution..."
        ln -sf "$PWD/components" node_modules/@components 2>/dev/null || true

    - name: Build application
      run: |
        echo "Building Next.js application..."
        echo "Current directory: $PWD"
        echo "NODE_PATH: $NODE_PATH"
        export NODE_PATH="$PWD:$NODE_PATH"
        npm run build
        ls -la .next/ || echo "No .next directory found"

    - name: Azure Login
      uses: azure/login@v1
      with:
        publish-profile: ${{ secrets.AZUREAPPSERVICE_PUBLISHPROFILE_APP_002_GEN10_STEP3_2_NODE_OSHIMA13 }}

    - name: Stop Azure Web App
      uses: azure/cli@v1
      with:
        azcliversion: 2.53.0
        inlineScript: |
          echo "Stopping Web App to avoid deployment conflicts..."
          az webapp stop --name app-002-gen10-step3-2-node-oshima13 --resource-group appsvc_rg_linux_japaneast || true

    - name: Deploy to Azure Web App
      uses: azure/webapps-deploy@v2
      with:
        app-name: app-002-gen10-step3-2-node-oshima13
        publish-profile: ${{ secrets.AZUREAPPSERVICE_PUBLISHPROFILE_APP_002_GEN10_STEP3_2_NODE_OSHIMA13 }}
        package: .

    - name: Start Azure Web App
      uses: azure/cli@v1
      with:
        azcliversion: 2.53.0
        inlineScript: |
          echo "Starting Web App after deployment..."
          az webapp start --name app-002-gen10-step3-2-node-oshima13 --resource-group appsvc_rg_linux_japaneast
